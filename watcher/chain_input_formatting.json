{
  "trigger": {
    "schedule": {
      "interval": "5m"
    }
  },
  "input": {
    "chain": {
      "inputs": [
        {
          "test1": {
            "search": {
              "request": {
                "search_type": "query_then_fetch",
                "indices": [
                  "test-data-*"
                ],
                "rest_total_hits_as_int": true,
                "body": {
                  "size": 0,
                  "track_total_hits": true,
                  "query": {
                    "bool": {
                      "must": [
                        {
                          "match": {
                            "component": "Test 1"
                          }
                        },
                        {
                          "match": {
                            "field1": "abc"
                          }
                        },
                        {
                          "range": {
                            "@timestamp": {
                              "gte": "now-5m",
                              "lte": "now"
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              }
            }
          }
        },
        {
          "test2": {
            "search": {
              "request": {
                "search_type": "query_then_fetch",
                "indices": [
                  "test-data-*"
                ],
                "rest_total_hits_as_int": true,
                "body": {
                  "size": 0,
                  "track_total_hits": true,
                  "query": {
                    "bool": {
                      "must": [
                        {
                          "match": {
                            "component.keyword": "Test 2"
                          }
                        },
                        {
                          "match": {
                            "field1": "def"
                          }
                        },
                        {
                          "range": {
                            "@timestamp": {
                              "gte": "now-15m",
                              "lte": "now"
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              }
            }
          }
        }
      ]
    }
  },
  "condition": {
    "script": {
      "source": "return ctx.payload.test1.hits.total < 2000 || ctx.payload.test2.hits.total < 2000",
      "lang": "painless"
    }
  },
  "actions": {
    "email_admin": {
      "throttle_period_in_millis": 3600000,
      "email": {
        "profile": "standard",
        "priority": "high",
        "to": [
          "test@testmail.com"
        ],
        "subject": "Test Data",
        "body": {
          "html": "Dear User,<br><br>As per Dashboard configuration settings, you are been identified to receive this email.<br><br>Chart name: <b>\"Test Data\"</b><br><br>We would like to alert that the logs count coming from one or more environment is below the threshold limit.<br><br><table style='border:1px solid;border-collapse:collapse;'><tr><th style='border:1px solid;border-collapse:collapse; width:100px'>Test Env</th><th style='border:1px solid;border-collapse:collapse;width:100px'>Total Hits</th><th style='border:1px solid;border-collapse:collapse; width:200px'>Acceptable Total Hits</th><th style='border:1px solid;border-collapse:collapse;width:150px'>Alert (True/False)</tr><tr><td style='border:1px solid;border-collapse:collapse;'>test1</td><td style='border:1px solid;border-collapse:collapse;'>{{ctx.vars.test1_hits}}</td><td style='border:1px solid;border-collapse:collapse;'>should be more than 2000</td><td style='background-color: {{ctx.vars.test1_color}};border:1px solid;'>{{ctx.vars.test1}}</td></tr><tr><td style='border:1px solid;border-collapse:collapse;'>test2</td><td style='border:1px solid;border-collapse:collapse;'>{{ctx.vars.test2_hits}}</td><td style='border:1px solid;border-collapse:collapse;'>should be more than 2000</td><td style='background-color: {{ctx.vars.test2_color}};border:1px solid;'>{{ctx.vars.test2}}</td></tr></table><br>Kindly take necessary actions.<br><br><i>Report generated by ELK. This is system generated email, please do not reply.</i>"
        }
      }
    }
  },
  "transform": {
    "script": {
      "source": "ctx.vars.test1=(ctx.payload.test1.hits.total<2000)?\"True\":\"False\";ctx.vars.test2=(ctx.payload.test2.hits.total<2000)?\"True\":\"False\";ctx.vars.test1_hits=ctx.payload.test1.hits.total;ctx.vars.test2_hits=ctx.payload.test2.hits.total;ctx.vars.test1_color=(ctx.payload.test1.hits.total<2000)?\"red\":\"white\";ctx.vars.test2_color=(ctx.payload.test2.hits.total<2000)?\"red\":\"white\";",
      "lang": "painless"
    }
  }
}